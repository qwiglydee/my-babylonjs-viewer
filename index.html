<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test page</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <style>
        body {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: start;
            gap: 16px;
            padding: 16px;
        }

        my-viewer {
            width: 800px;
            height: 600px;
        }

        section {
            margin-bottom: 1rem;
            padding: 1rem;
        }
    </style>
    <script type="module" src="./src/index.ts"></script>
</head>

<body>
    <my-viewer>
        <my-camera autospin autospinDelay="5000" autozoom></my-camera>
        <my-environ>
            <my-sky intensity="0.25" blurring="0.75"></my-sky>
            <my-ground></my-ground>
        </my-environ>
        <!-- <my-stub></my-stub> -->
        <my-model class="base" id="suzanne" src="assets/monkey.glb"></my-model>
        <my-model class="base" id="plane2" src="assets/plane2.glb" selected></my-model>
        <my-model class="base" id="plane3" src="assets/plane3.glb"></my-model>
        <my-model class="part" id="gear1" src="assets/plane-gear1.glb" anchor="gear" selected></my-model>
        <my-model class="part" id="gear2" src="assets/plane-gear2.glb" anchor="gear"></my-model>
        <my-part class="part" id="hood" target="hood"></my-part>
        <my-part class="part" id="tail" target="tail2"></my-part>
        <div slot="overlay" style="position: absolute; top: 4px; left: 4px;">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
                <path
                    d="M520-360h120q33 0 56.5-23.5T720-440v-80q0-33-23.5-56.5T640-600H520v240Zm60-60v-120h60q8 0 14 6t6 14v80q0 8-6 14t-14 6h-60Zm-320 60h140q17 0 28.5-11.5T440-400v-40q0-17-11.5-28.5T400-480q17 0 28.5-11.5T440-520v-40q0-17-11.5-28.5T400-600H260v60h120v30h-80v60h80v30H260v60ZM160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm0-80h640v-480H160v480Zm0 0v-480 480Z" />
            </svg>
        </div>
    </my-viewer>
    <div>
        <section class="border rounded-3 mb-3 p-3">
            <h5>Модель</h5>
            <select name="model" class="form-select">
                <option value="suzanne">suzanne</option>
                <option value="plane2">plane2</option>
                <option value="plane3">plane3</option>
            </select>
        </section>
        <section id="menu-skins" class="border rounded-3 rounded-3 mb-3 p-3">
            <h5>Расцветка</h5>
            <div class="form-check">
                <input id="check-s1" type="radio" name="skin" value="acrobatic" class="form-check-input">
                <label for="check-s1" class="form-check-label">Клоунская</label>
            </div>
            <div class="form-check">
                <input id="check-s2" type="radio" name="skin" value="fighter" class="form-check-input">
                <label for="check-s2" class="form-check-label">Боевая</label>
            </div>
        </section>
        <section id="menu-items" class="border rounded-3 rounded-3 mb-3 p-3">
            <h5>Комплектация</h5>
            <div class="form-check">
                <input id="check-g1" type="radio" name="item" value="gear1" class="form-check-input">
                <label for="check-g1" class="form-check-label">Шасси: летнее</label>
            </div>
            <div class="form-check">
                <input id="check-g2" type="radio" name="item" value="gear2" class="form-check-input">
                <label for="check-g2" class="form-check-label">Шасси: зимнее</label>
            </div>
            <div class="form-check">
                <input id="check-p1" type="checkbox" name="item" value="hood" class="form-check-input">
                <label for="check-p1" class="form-check-label">Кабина</label>
            </div>
            <div class="form-check">
                <input id="check-p2" type="checkbox" name="item" value="tail" class="form-check-input">
                <label for="check-p2" class="form-check-label">Хвостик</label>
            </div>
        </section>
    </div>
</body>
    <script>
        var my = {
            viewer: document.querySelector("my-viewer"),
            camera: document.querySelector('my-camera'),
            environ: document.querySelector('my-environ'),
            basemodels: document.querySelectorAll('my-model.base'),
            partmodels: document.querySelectorAll('my-model.part'),
            modelparts: document.querySelectorAll('my-part.part'),
        }

        var ui = {
            model: document.querySelector("[name=model]"),
            items: document.querySelector("#menu-items"),
            skins: document.querySelector("#menu-skins"),
        }

        function queueTask(fn) { setTimeout(fn, 17); }

        ui.model.addEventListener('change', function (e) {
            let input = e.target;
            let item = document.getElementById(input.value);
            my.basemodels.forEach(m => m.selected = m.id == input.value);
        });

        ui.items.addEventListener('change', function (e) {
            let input = e.target;
            let item = document.getElementById(input.value);
            item.selected = input.checked;
            document.querySelectorAll(`[anchor=${item.anchor}]`).forEach(it => { if (it !== item) it.selected = false });
        });

        ui.skins.addEventListener('change', function (e) {
            let input = e.target;
            my.basemodels.forEach(m => m.skin = input.value);
            my.partmodels.forEach(m => m.skin = input.value);
        });

        my.viewer.addEventListener('model-updated', function (e) {
            let item = e.target;
            console.debug("model-updated", item, item.skin)
            if (item.selected) {
                if (item.classList.contains('base')) queueTask(() => my.camera.reset());
                if (item.classList.contains('part')) queueTask(() => my.camera.reframe());
                if (item.classList.contains('base')) ui.skins.querySelectorAll("input").forEach(input => input.checked = (input.value == item.skin));
            }
        });

        my.viewer.addEventListener('part-updated', function (e) {
            let item = e.target;
            if (item.selected) {
                queueTask(() => my.camera.reframe());
            }
        });

        my.viewer.addEventListener('scene-updated', function (e) {
            my.basemodels.forEach(item => {
                if (item.selected) ui.model.value = item.id;
            })

            my.partmodels.forEach(item => {
                let input = ui.items.querySelector(`[value=${item.id}]`);
                input.disabled = item.disabled;
                input.checked = item.selected;
            });

            my.modelparts.forEach(item => {
                let input = ui.items.querySelector(`[value=${item.id}]`);
                input.disabled = item.disabled;
                input.checked = item.selected;
            });
        });
    </script>

</html>